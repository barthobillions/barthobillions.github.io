<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NatPass Dashboard</title>
  <link rel="stylesheet" href="/natpass/css/styles.css" />
</head>
<body>
  <h1>NatPass Dashboard</h1>
  <button id="logout-btn">Logout</button>

  <h2>Saved Credentials</h2>
  <div id="credentials-container"></div>

  <h2>Add New Credential</h2>
  <form id="add-credential-form">
    <input type="text" id="cred-name" placeholder="Name" required />
    <input type="text" id="cred-site" placeholder="Site" required />
    <input type="text" id="cred-username" placeholder="Username" required />
    <input type="password" id="cred-password" placeholder="Password" required />
    <input type="password" id="cred-password-confirm" placeholder="Confirm Password" required />
    <button type="submit">Save Credential</button>
  </form>

  <script type="module">
    import { supabase } from '/natpass/js/supabase.js';
    import { saveCredential, loadCredentials, deleteCredential } from '/natpass/js/credentials.js';

    const logoutBtn = document.getElementById('logout-btn');
    const addForm = document.getElementById('add-credential-form');
    const container = document.getElementById('credentials-container');

    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = "/natpass/index.html";
    });

    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('cred-name').value;
      const site = document.getElementById('cred-site').value;
      const username = document.getElementById('cred-username').value;
      const password = document.getElementById('cred-password').value;
      const confirmPassword = document.getElementById('cred-password-confirm').value;

      if (password !== confirmPassword) {
        alert("Passwords do not match");
        return;
      }

      try {
        await saveCredential(name, site, username, password);
        addForm.reset();
        await renderCredentials();
      } catch (err) {
        console.error(err);
        alert("Failed to save credential.");
      }
    });

    async function renderCredentials() {
      try {
        const credentials = await loadCredentials();
        container.innerHTML = "";

        if (!credentials.length) {
          container.innerHTML = "<p>No credentials found.</p>";
          return;
        }

        credentials.forEach(cred => {
          const div = document.createElement("div");
          div.innerHTML = `
            <strong>${cred.name}</strong><br/>
            Site: ${cred.site_name}<br/>
            Username: ${cred.account_username}<br/>
            Password: <span class="password" data-id="${cred.id}">********</span><br/>
            <button class="show-btn" data-id="${cred.id}">Show</button>
            <button class="delete-btn" data-id="${cred.id}">Delete</button>
            <hr/>
          `;
          container.appendChild(div);
        });

        document.querySelectorAll('.show-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const span = document.querySelector(`.password[data-id="${id}"]`);
            const cred = credentials.find(c => c.id == id);
            if (span.textContent === '********') {
              span.textContent = cred.password_decrypted || 'Decryption error';
              btn.textContent = 'Hide';
            } else {
              span.textContent = '********';
              btn.textContent = 'Show';
            }
          });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            if (confirm('Delete this credential?')) {
              await deleteCredential(id);
              await renderCredentials();
            }
          });
        });
      } catch (err) {
        console.error("Error loading credentials:", err);
        container.innerHTML = "<p>Error loading credentials.</p>";
      }
    }

    renderCredentials();
  </script>
</body>
</html>
