<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NatPass Dashboard</title>
  <link rel="stylesheet" href="/natpass/css/styles.css" />
</head>
<body>
  <header>
    <h1>üîê NatPass</h1>
    <button id="logout-btn" class="logout-btn">Logout</button>
  </header>

  <main>
    <button id="add-credential-btn" class="primary-btn">‚ûï Add Credential</button>

    <form id="add-credential-form" class="form hidden">
      <input type="text" id="cred-name" placeholder="Name" required />
      <input type="text" id="cred-site" placeholder="Site" required />
      <input type="text" id="cred-username" placeholder="Username" required />
      <input type="password" id="cred-password" placeholder="Password" required />
      <input type="password" id="cred-password-confirm" placeholder="Confirm Password" required />
      <button type="submit" class="primary-btn">üíæ Save</button>
    </form>

    <div id="credentials-container" class="credential-board"></div>
  </main>

  <script type="module">
    import { supabase } from '/natpass/js/supabase.js';
    import { saveCredential, loadCredentials, deleteCredential } from '/natpass/js/credentials.js';

    const form = document.getElementById('add-credential-form');
    const addBtn = document.getElementById('add-credential-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const container = document.getElementById('credentials-container');

    addBtn.addEventListener('click', () => form.classList.toggle('hidden'));

    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = "/natpass/index.html";
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('cred-name').value;
      const site = document.getElementById('cred-site').value;
      const username = document.getElementById('cred-username').value;
      const password = document.getElementById('cred-password').value;
      const confirm = document.getElementById('cred-password-confirm').value;

      if (password !== confirm) {
        alert('Passwords do not match!');
        return;
      }

      try {
        await saveCredential(name, site, username, password);
        form.reset();
        form.classList.add('hidden');
        await loadAndRenderCredentials();
      } catch (err) {
        alert(err.message);
      }
    });

    async function loadAndRenderCredentials() {
      const creds = await loadCredentials();
      container.innerHTML = '';

      if (!creds.length) {
        container.innerHTML = '<p class="empty">No credentials saved yet.</p>';
        return;
      }

      creds.forEach(cred => {
        const el = document.createElement('div');
        el.className = 'note';
        el.innerHTML = `
          <h3>${cred.name}</h3>
          <p><strong>Site:</strong> ${cred.site_name}</p>
          <p><strong>User:</strong> ${cred.account_username}</p>
          <p><strong>Password:</strong> <span class="pw" data-id="${cred.id}">********</span></p>
          <div class="note-buttons">
            <button class="show-btn" data-id="${cred.id}">Show</button>
            <button class="delete-btn" data-id="${cred.id}">Delete</button>
          </div>
        `;
        container.appendChild(el);
      });

      document.querySelectorAll('.show-btn').forEach(btn =>
        btn.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          const span = document.querySelector(`.pw[data-id="${id}"]`);
          const cred = creds.find(c => c.id == id);
          if (span.textContent === '********') {
            span.textContent = cred.password_decrypted || 'Error';
            btn.textContent = 'Hide';
          } else {
            span.textContent = '********';
            btn.textContent = 'Show';
          }
        }));

      document.querySelectorAll('.delete-btn').forEach(btn =>
        btn.addEventListener('click', async (e) => {
          await deleteCredential(e.target.dataset.id);
          await loadAndRenderCredentials();
        }));
    }

    loadAndRenderCredentials();
  </script>
</body>
</html>
